<app-header></app-header>

<!-- ============================================ -->
<!-- LOADING STATE: Event Detail Page            -->
<!-- Buscar por: "LOADING_EVENT_DETAIL"          -->
<!-- ============================================ -->
<div *ngIf="!(event$ | async)" class="min-h-screen bg-background pb-20 flex items-center justify-center">
    <app-loading-spinner size="lg" message="Cargando evento..."></app-loading-spinner>
</div>

<div *ngIf="event$ | async as event" class="min-h-screen bg-background pb-20">

    <!-- Banner / Hero -->
    <div class="relative h-[400px] w-full bg-white overflow-hidden flex items-center justify-center">
        <img [src]="event.coverImageUrl || 'assets/placeholder-event.jpg'" [alt]="event.nameInternal"
            class="w-full h-full object-cover opacity-70"
            onerror="this.style.display='none'; this.parentElement.querySelector('.fallback-logo').style.display='flex';">
        <div class="fallback-logo hidden flex-col items-center justify-center absolute inset-0" style="display:none;">
            <img src="assets/images/logo-icon.jpg" alt="EnPuerta" class="h-32 w-32 object-contain opacity-20">
        </div>
        <div class="absolute inset-0 bg-gradient-to-t from-slate-900/90 via-slate-900/40 to-transparent"></div>

        <div class="absolute bottom-0 left-0 right-0 max-w-6xl mx-auto px-6 pb-12">
            <div class="flex flex-col gap-4">
                <!-- Chip -->
                <div>
                    <span
                        class="inline-block bg-primary text-white text-sm font-bold px-3 py-1 rounded-full uppercase tracking-wider">
                        {{ event.eventType }}
                    </span>
                </div>

                <!-- Title -->
                <h1 class="text-4xl md:text-5xl font-bold text-white tracking-tight drop-shadow-sm">
                    {{ event.aliasPublic }}
                </h1>

                <!-- Location -->
                <div class="flex items-center gap-2 text-slate-200 text-lg">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5"
                        stroke="currentColor" class="w-5 h-5">
                        <path stroke-linecap="round" stroke-linejoin="round"
                            d="M15 10.5a3 3 0 1 1-6 0 3 3 0 0 1 6 0Z" />
                        <path stroke-linecap="round" stroke-linejoin="round"
                            d="M19.5 10.5c0 7.142-7.5 11.25-7.5 11.25S4.5 17.642 4.5 10.5a7.5 7.5 0 1 1 15 0Z" />
                    </svg>
                    <span class="font-medium hover:text-white transition-colors cursor-pointer">{{ event.locationAddress
                        }}</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Content -->
    <main class="max-w-6xl mx-auto px-6 -mt-8 relative z-10">
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">

            <!-- Left Column: Description -->
            <div class="lg:col-span-2">
                <div class="bg-white rounded-xl shadow-sm p-8 border border-slate-200">
                    <h2 class="text-2xl font-bold text-slate-900 mb-6">Sobre el evento</h2>
                    <div class="prose prose-slate max-w-none text-slate-600 leading-relaxed whitespace-pre-line">
                        {{ event.descriptionLong || event.descriptionShort }}
                    </div>
                </div>
            </div>

            <!-- Right Column: Functions -->
            <div class="lg:col-span-1">
                <div class="bg-white rounded-xl shadow-lg border border-slate-200 p-6 sticky top-24">

                    <!-- Pricing Info -->
                    <div class="mb-6 p-4 rounded-lg" [ngClass]="{
                           'bg-green-50 border border-green-200': event.pricingType === 'free',
                           'bg-amber-50 border border-amber-200': event.pricingType === 'pay-what-you-want',
                           'bg-primary/5 border border-primary/20': event.pricingType === 'fixed'
                         }">
                        <div class="flex items-center justify-between">
                            <span class="text-sm font-medium text-slate-600">Precio</span>
                            <span class="text-xl font-bold" [ngClass]="{
                                    'text-green-700': event.pricingType === 'free',
                                    'text-amber-700': event.pricingType === 'pay-what-you-want',
                                    'text-primary': event.pricingType === 'fixed'
                                  }">
                                <ng-container [ngSwitch]="event.pricingType">
                                    <span *ngSwitchCase="'free'">Gratis ðŸŽ‰</span>
                                    <span *ngSwitchCase="'pay-what-you-want'">
                                        A la gorra ðŸŽ©
                                        <span *ngIf="event.suggestedPrice" class="block text-sm font-normal mt-1">
                                            Sugerido: ${{ event.suggestedPrice }}
                                        </span>
                                    </span>
                                    <span *ngSwitchCase="'fixed'">${{ event.defaultPrice }}</span>
                                </ng-container>
                            </span>
                        </div>
                    </div>

                    <!-- Functions Section -->
                    <div *ngIf="(functions$ | async) as functions">
                        <!-- Single Function View (when there's exactly 1 function) -->
                        <div *ngIf="functions.length === 1 && functions[0]" class="space-y-4">
                            <h3 class="text-xl font-bold text-slate-900 flex items-center gap-2">
                                <span>ðŸŽ­</span> FunciÃ³n Ãºnica
                            </h3>

                            <div class="space-y-3 p-4 bg-background rounded-lg border border-primary/10">
                                <div class="flex items-center gap-2 text-slate-700">
                                    <span class="text-2xl">ðŸ“…</span>
                                    <div>
                                        <div class="font-semibold">{{ functions[0].dateTime | date: 'EEEE d MMMM, y' |
                                            titlecase }}</div>
                                        <div class="text-sm text-slate-500">{{ functions[0].dateTime | date: 'HH:mm' }}
                                            hs</div>
                                    </div>
                                </div>

                                <div class="flex items-center gap-2 text-slate-700">
                                    <span class="text-2xl">ðŸ‘¥</span>
                                    <div class="text-sm">
                                        <span class="font-medium">Disponibles:</span> {{ functions[0].availableCapacity
                                        ?? functions[0].capacity }} de {{ functions[0].capacity }} lugares
                                    </div>
                                </div>
                            </div>

                            <a [routerLink]="['/e', event.aliasPublic, 'f', functions[0].functionId, 'booking']"
                                *ngIf="(functions[0].availableCapacity ?? functions[0].capacity) > 0"
                                class="block w-full text-center bg-primary hover:bg-primary-hover text-white font-bold py-3 rounded-lg transition-colors shadow-sm">
                                Reservar ahora
                            </a>

                            <div *ngIf="(functions[0].availableCapacity ?? functions[0].capacity) === 0"
                                class="block w-full text-center bg-red-700 text-white font-bold py-3 rounded-lg cursor-not-allowed">
                                Agotado
                            </div>
                        </div>

                        <!-- Multiple Functions View (when there are 2+ functions) -->
                        <div *ngIf="functions.length > 1">
                            <h3 class="text-xl font-bold text-slate-900 mb-6 flex items-center gap-2">
                                <span>ðŸ“…</span> ElegÃ­ una funciÃ³n
                            </h3>

                            <!-- Function List Component -->
                            <app-function-list [functions]="functions"
                                [eventAlias]="event.aliasPublic || ''"></app-function-list>
                        </div>

                        <!-- No Functions Available -->
                        <div *ngIf="functions.length === 0" class="text-center py-8">
                            <p class="text-slate-500">No hay funciones disponibles en este momento.</p>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </main>

</div>

<!-- Loading State -->
<div *ngIf="loading" class="min-h-screen bg-background flex items-center justify-center">
    <div class="animate-pulse flex flex-col items-center">
        <div class="h-12 w-12 bg-slate-300 rounded-full mb-4"></div>
        <div class="h-4 w-32 bg-slate-300 rounded"></div>
    </div>
</div>